{{include("header")/}}


<div class="text-center mb-4">
    <h2 id="settings" class="multilang">Settings</h2>
</div>


<div class="row justify-content-md-center">
    <div class="col-md-7">

        <!-- Global Card -->
        <div class="card card-accent-danger">
            <!-- <div class="card-header font-weight-bold">Global:</div> -->
            <div class="card-header font-weight-bold">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-item nav-link active multilang" id="nav-global-tab" data-toggle="tab" href="#nav-global"
                            role="tab" aria-controls="nav-global" aria-selected="true">Global</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-item nav-link " id="nav-fxserver-tab" data-toggle="tab" href="#nav-fxserver"
                            role="tab" aria-controls="nav-fxserver" aria-selected="true">FXServer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-item nav-link multilang" id="nav-monitor-tab" data-toggle="tab" href="#nav-monitor"
                            role="tab" aria-controls="nav-monitor" aria-selected="true">Monitor/Restarter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-item nav-link " id="nav-discord-tab" data-toggle="tab" href="#nav-discord"
                            role="tab" aria-controls="nav-discord" aria-selected="true">Discord</a>
                    </li>
                </ul>
            </div>

            <div class="card-body settings-card">
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-global" role="tabpanel"
                        aria-labelledby="nav-global-tab">

                        <!-- Global Card -->
                        <div class="form-group row">
                            <label for="frmGlobal-serverName" class="col-sm-3 col-form-label">
                                <span id="servername" class="multilang">Server Name</span>
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmGlobal-serverName"
                                    value="{{global.serverName}}" maxlength="24" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="id" class="multilang">A <strong>short</strong> server name to be used in txAdmin interface and Chat/Discord messages.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmGlobal-publicIP" class="col-sm-3 col-form-label">
                                 <span id="pubip" class="multilang">Public IP</span>
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="frmGlobal-publicIP"
                                        value="{{global.publicIP}}" maxlength="32" placeholder="123.123.123.123" {{disableWrite}}>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary multilang" id="frmGlobal-getIP"
                                            type="button" {{disableWrite}}>Auto Detect</button>
                                    </div>
                                </div>
                                <span class="form-text text-muted">
                                    <span id="sent3" class="multilang">You can set this to be your public IP or a domain name.</span> <br>
                                    <span id="sent4" class="multilang"><b>Note:</b> The auto detect feature might get blocked by ad-blockers.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmGlobal-serverName" class="col-sm-3 col-form-label">
                                 <span id="language1" class="multilang">Language</span>
                            </label>
                            <div class="col-sm-9">
                                <select class="form-control" id="frmGlobal-language" {{disableWrite}}>
                                    <!-- TODO: make this list dynamic -->
                                    <option value="en" {{global.language=='en'|isSelected}}>English</option>
                                    <option value="cs" {{global.language=='cs'|isSelected}}>Czech</option>
                                    <option value="de" {{global.language=='de'|isSelected}}>German</option>
                                    <option value="pt_BR" {{global.language=='pt_BR'|isSelected}}>Portuguese (Brazil)</option>
                                    <option value="ro" {{global.language=='ro'|isSelected}}>Romanian</option>
                                    <option value="custom" {{global.language=='custom'|isSelected}}>Custom (read the documentation)</option>
                                </select>
                                <span class="form-text text-muted">
                                    <span id="sent5" class="multilang">The language to use on Chat/Discord messages.</span> <br>
                                    <span id="sent6" class="multilang"><b>Note:</b> For the Custom option, read the documentation.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmGlobal-verbose" id="verbose" class="col-sm-3 col-form-label multilang">Verbose</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmGlobal-verbose"
                                        {{global.verbose}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    <span id="sent7" class="multilang">By enabling verbosity you will see more detailed information in the terminal.</span> <br>
                                    <span id="sent8" class="multilang">This may help you troubleshoot some errors.</span>
                                </span>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-sm btn-primary" type="submit" id="frmGlobal-save" {{disableWrite}}>
                                <i class="icons cui-check"></i> <span id="savglob" class="multilang">Save Global Settings</span>
                            </button>
                        </div>
                        <!-- /Global Card -->

                    </div>
                    <div class="tab-pane fade" id="nav-fxserver" role="tabpanel" aria-labelledby="nav-fxserver-tab">

                        <!-- FXServer Card -->
                        <div class="form-group row">
                            <label for="frmFXServer-buildPath" class="col-sm-3 col-form-label"><span id="buildp" class="multilang">Build Path</span>
                                <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmFXServer-buildPath" value="{{fxserver.buildPath}}"
                                    placeholder="C:/Users/Admin/Documents/fxserver_builds/1380" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="sent9" class="multilang">The folder containing the files <code>run.cmd</code>, <code>fxserver.exe</code> and</span>
                                    <span id="sent10" class="multilang">a bunch of DLLs in case of Windows, and only <code>run.sh</code> in case of Linux.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-basePath" class="col-sm-3 col-form-label"><span id="basep" class="multilang">Base Path</span>
                                <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmFXServer-basePath" value="{{fxserver.basePath}}"
                                    placeholder="C:/Users/Admin/Desktop/server01" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="sent11" class="multilang">The folder that <strong>contains</strong> the <code>resources</code> and</span>
                                    <span id="sent12" class="multilang"><code>cache</code> folders, usually it's here that you put your</span>
                                    <span id="sent13" class="multilang"><code>server.cfg</code>.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-cfgPath" class="col-sm-3 col-form-label"><span id="cfgp" class="multilang">CFG Path</span>
                                <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmFXServer-cfgPath" value="{{fxserver.cfgPath}}"
                                    placeholder="C:/Users/Admin/Desktop/server01/server.cfg" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="sent14" class="multilang">The absolute or relative (to the Base) path of your <code>server.cfg</code>.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-onesync" class="col-sm-3 col-form-label">OneSync</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmFXServer-onesync"
                                        {{fxserver.onesync}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    <span id="required" class="multilang">Required if you server has more than 32 slots.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-autostart" id="autos" class="col-sm-3 col-form-label multilang">Autostart</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmFXServer-autostart"
                                        {{fxserver.autostart}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    <span id="sent15" class="multilang">Start the server automatically after <strong>txAdmin</strong> starts.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-quiet" id="quiet" class="col-sm-3 col-form-label multilang">Quiet</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmFXServer-quiet"
                                        {{fxserver.quiet}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    <span id="sent16" class="multilang">Do not print FXServer's output to the terminal. You will still be able to use the</span>
                                    <span id="sent17" class="multilang">Live Console.</span>
                                </span>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-sm btn-primary" type="submit" id="frmFXServer-save" {{disableWrite}}>
                                <i class="icons cui-check"></i> <span id="safer" class="multilang">Save FXServer Settings</span>
                            </button>
                        </div>
                        <!-- /FXServer Card -->

                    </div>
                    <div class="tab-pane fade" id="nav-monitor" role="tabpanel" aria-labelledby="nav-monitor-tab">

                        <!-- Monitor Card -->
                        <div class="form-group row">
                            <label for="frmMonitor-conservative" id="conser" class="col-sm-3 col-form-label multilang">Conservative Mode</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmMonitor-conservative"
                                        checked disabled>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    <span id="sent18" class="multilang">Try not to restart the server when it is still working. <br></span>
                                    <span id="sent19" class="multilang">This feature is still in beta</span>
                                </span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="frmMonitor-timeout" class="col-sm-3 col-form-label">
                                <span id="time" class="multilang">Timeout</span>
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-9">
                                <input type="number" class="form-control" id="frmMonitor-timeout" value="{{monitor.timeout}}"
                                    placeholder="1000" min="0" max="5000" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="sent20" class="multilang">The limit of <strong>milliseconds</strong> for the FXServer to respond before the</span>
                                    <span id="sent21" class="multilang">Monitor considers it unresponsive. (Recommended: 1000. Max: 5000)</span>
                                </span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="frmMonitor-failures" class="col-sm-3 col-form-label">
                                <span id="maxf" class="multilang">Max Failures</span> <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-9">
                                <input type="number" class="form-control" id="frmMonitor-failures" value="{{monitor.restarter.failures}}"
                                    placeholder="15" min="5" max="120" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="sent22" class="multilang">The number of timeouts before the Monitor attempts to restart FXServer (60s of</span>
                                    <span id="sent23" class="multilang">cooldown may apply). <br></span>
                                    <span id="sent24" class="multilang">This should be equivalent of more than 15s when multiplied by the timeout.</span>
                                </span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="frmMonitor-schedule" id="schr" class="col-sm-3 col-form-label multilang">Scheduled Restarts</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmMonitor-schedule" value="{{monitor.restarter.schedule}}"
                                    placeholder="05:00, 13:00" {{disableWrite}}>
                                <span class="form-text text-danger font-weight-boldx" id="frmMonitor-timezoneAlert"></span>
                                <span class="form-text text-muted">
                                    <span id="sent25" class="multilang">At which times of day to restart the server. Leave it blank to disable this feature. <br></span>
                                    <span id="sent26" class="multilang">The time MUST be in the 24-hour format with two digits for hours as well as</span>
                                    <span id="sent27" class="multilang">minutes (<code>HH:MM</code>) and the times should be separated by commas. <br></span>
                                    <span id="sent28" class="multilang"><strong>Note:</strong> Make sure your schedule matches your server time and not your local time.</span>
                                </span>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-sm btn-primary" type="submit" id="frmMonitor-save" {{disableWrite}}>
                                <i class="icons cui-check"></i> <span id="sms" class="multilang">Save Monitor/Restarter Settings</span>
                            </button>
                        </div>
                        <!-- /Monitor Card -->

                    </div>
                    <div class="tab-pane fade" id="nav-discord" role="tabpanel" aria-labelledby="nav-discord-tab">

                        <!-- Discord Card -->
                        <div class="form-group row">
                            <label for="frmDiscord-enabled" id="enabot" class="col-sm-3 col-form-label multilang">Enable Bot</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmDiscord-enabled"
                                        {{discord.enabled}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    <span id="enaint" class="multilang">Enable Discord Integration.</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmDiscord-token" class="col-sm-3 col-form-label"><span id="tokn" class="multilang">Token</span> <span
                                    class="text-danger">*</span></label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmDiscord-token" value="{{discord.token}}"
                                    maxlength="96" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="sent29" class="multilang">To get a token and the bot to join your server, follow these two guides:</span>
                                    <a href="https://discordjs.guide/preparations/setting-up-a-bot-application.html"
                                        target="_blank" rel="noopener noreferrer"><span id="sent30" class="multilang">Setting up a bot application</span></a> <span id="and" class="multilang">and</span>
                                    <a href="https://discordjs.guide/preparations/adding-your-bot-to-servers.html"><span id="sent31" class="multilang">Adding
                                        your bot to servers</span></a>.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmDiscord-announceChannel" id="ann11" class="col-sm-3 col-form-label multilang">Announcements Channel ID</label>
                            <div class="col-sm-9">
                                <input type="number" class="form-control" id="frmDiscord-announceChannel"
                                    value="{{discord.announceChannel}}" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="sent32" class="multilang">The ID of the channel to send Announcements (eg server restarts).</span> <br>
                                    <span id="sent33" class="multilang">Leave it blank to disable this feature.</span> <br>
                                    <span id="sent34" class="multilang">To get the channel ID, go to Discord's settings and</span>
                                    <a href="https://support.discordapp.com/hc/article_attachments/115002742731/mceclip0.png"
                                    target="_blank" ><span id="sent35" class="multilang">enable developer mode</span></a>, <span id="sent36" class="multilang">then right-click on the channel name and select "Copy ID".</span>
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmDiscord-statusCommand" class="col-sm-3 col-form-label">
                                <span id="stutas" class="multilang">Status Command</span>
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmDiscord-statusCommand" value="{{discord.statusCommand}}"
                                    placeholder="/status" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    <span id="sent37" class="multilang">The command that will trigger a status message from the bot.</span>
                                </span>
                            </div>
                        </div>


                        <div class="text-center mt-4">
                            <button class="btn btn-sm btn-primary" type="submit" id="frmDiscord-save" {{disableWrite}}>
                                <i class="icons cui-check"></i> <span id="savedise" class="multilang">Save Discord Settings</span>
                            </button>
                        </div>
                        <!-- /Discord Card -->

                    </div>
                </div>
            </div>


        </div>

    </div>
</div>


{{include("footer")/}}

<script>
    //============================================== General
    let serverTimezone = "{{serverTimezone}}";
    let browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if(serverTimezone !== browserTimezone){
        let msg = `Your timezone: <b>${browserTimezone}</b> <br>
            Server's timezone: <b>${serverTimezone}</b> <br>
            Make sure to adjust the times to match your expectations.`;
        $('#frmMonitor-timezoneAlert').html(msg);
    }


    $(document).ready(function () {
        if ($('#frmGlobal-publicIP').val().trim() == 'change-me') {
            $('#frmGlobal-getIP').click();
        }
    });

    //============================================== Global Settings
    $('#frmGlobal-getIP').click(function () {
        $('#frmGlobal-publicIP').val('retrieving...');
        $.ajax({
            type: "GET",
            url: 'https://api.ipify.org?format=json',
            timeout: 3000,
            success: function (data) {
                $('#frmGlobal-publicIP').val(data.ip);
            },
            error: function (xmlhttprequest, textstatus, message) {
                $('#frmGlobal-publicIP').val('error');
            }
        });
    });

    $('#frmGlobal-save').click(function () {
        let data = {
            serverName: $('#frmGlobal-serverName').val().trim(),
            publicIP: $('#frmGlobal-publicIP').val().trim(),
            language: $('#frmGlobal-language').val(),
            verbose: $('#frmGlobal-verbose').is(':checked')
        }
        if (!data.serverName.length || !data.serverName.length) {
            var notify = $.notify({ message: 'The fields with "*" are required.' }, { type: 'warning' });
            return;
        }
        var notify = $.notify({ message: '<p class="text-center">Saving...</p>' }, {});

        $.ajax({
            type: "POST",
            url: '/saveSettings/global',
            timeout: 2000,
            data: data,
            dataType: 'json',
            success: function (data) {
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    });


    //============================================== FXServer Settings
    $('#frmFXServer-save').click(function () {
        let data = {
            buildPath: $('#frmFXServer-buildPath').val().trim(),
            basePath: $('#frmFXServer-basePath').val().trim(),
            cfgPath: $('#frmFXServer-cfgPath').val().trim(),
            onesync: $('#frmFXServer-onesync').is(':checked'),
            autostart: $('#frmFXServer-autostart').is(':checked'),
            quiet: $('#frmFXServer-quiet').is(':checked')
        }
        if (!data.buildPath.length || !data.basePath.length || !data.cfgPath.length) {
            var notify = $.notify({ message: 'The fields with "*" are required.' }, { type: 'warning' });
            return;
        }
        var notify = $.notify({ message: '<p class="text-center">Saving...</p>' }, {});

        $.ajax({
            type: "POST",
            url: '/saveSettings/fxserver',
            timeout: 2000,
            data: data,
            dataType: 'json',
            success: function (data) {
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    });


    //============================================== Monitor Settings
    $('#frmMonitor-save').click(function () {
        let data = {
            timeout: $('#frmMonitor-timeout').val(),
            failures: $('#frmMonitor-failures').val(),
            schedule: $('#frmMonitor-schedule').val().trim()
        }
        if (!data.timeout.length || !data.failures.length) {
            var notify = $.notify({ message: 'The fields with "*" are required.' }, { type: 'warning' });
            return;
        }
        var notify = $.notify({ message: '<p class="text-center">Saving...</p>' }, {});

        $.ajax({
            type: "POST",
            url: '/saveSettings/monitor',
            timeout: 2000,
            data: data,
            dataType: 'json',
            success: function (data) {
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    });


    //============================================== Discord Settings
    $('#frmDiscord-save').click(function () {
        let data = {
            enabled: ($('#frmDiscord-enabled').is(':checked') === true),
            token: $('#frmDiscord-token').val().trim(),
            announceChannel: $('#frmDiscord-announceChannel').val().trim(),
            statusCommand: $('#frmDiscord-statusCommand').val().trim()
        };
        if (data.enabled && (!data.token.length || !data.statusCommand.length)) {
            var notify = $.notify({ message: 'The fields with "*" are required when the bot is enabled.' }, { type: 'warning' });
            return;
        }
        var notify = $.notify({ message: '<p class="text-center">Saving...</p>' }, {});

        $.ajax({
            type: "POST",
            url: '/saveSettings/discord',
            timeout: 2000,
            data: data,
            dataType: 'json',
            success: function (data) {
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    });

</script>
