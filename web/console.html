{{@include("header", it)/}}


<style>
    .console-content {
        height: calc(100vh - 378px);
        margin: 0;
    }

    .console-input {
        width: 13rem !important;
    }

    @media only screen and (min-width: 768px) {
        .console-input {
            width: 32rem !important;
            margin-bottom: 1em;
        }
    }

    @media (min-width: 768px) and (max-width: 1024px) {
        .console-input {
            width: 20rem !important;
        }
    }

    /* Custom Scrollbar colors for dark console */
    .console-content::-webkit-scrollbar-track {
        background-color: #1E252D;
        border-right: 1px solid #1E252D;
        border-left: 1px solid #1E252D;
    }

    .console-content::-webkit-scrollbar-thumb {
        background-color: #565C62;
    }

    .console-content::-webkit-scrollbar-corner {
        background: #1E252D;
    }

    .bg-dark {
        background-color: #252E38 !important;
    }
</style>


<div class="text-center">
    <h3>FXServer Console</h3>
</div>
<div class="card bg-dark">
    <div class="card-body p-3">
        <pre id="console" class="thin-scroll console-content text-white"></pre>
    </div>
    <div class="card-footer text-center bg-dark">
        <form class="form-inline container-fluid" id="frmConsole">
            <div class="mx-auto">
                <div class="form-group">
                    <input type="text" class="form-control console-input form-control-sm" id="cmdInput"
                           placeholder="Press enter to send. Up/Down arrows to navigate commands."
                           autocomplete="off" autocorrect="off" autocapitalize="off" 
                           spellcheck="false"{{it.disableWrite}}>
                </div>
                <button type="button" id="clearConsole"
                        class="btn btn-outline-light btn-sm mb-2">Clear Console
                </button>
                <button type="button" id="toggleAutoScroll"
                        class="btn btn-outline-light btn-sm mb-2">Disable Scroll
                </button>
                <a href="/fxserver/downloadLog" target="_blank"
                   class="btn btn-outline-light btn-sm mb-2">Download Log</a>
            </div>
        </form>
    </div>
</div>

<div class="text-center">
    <h4>Commands Cache</h3>
</div>
<div class="card bg-dark">
    <div class="card-body p-3">
        <table class="table table-hover table-dark bg-dark">
		  <thead>
			<tr>
			  <th scope="col">#</th>
			  <th scope="col">Command</th>
			  <th scope="col">Options</th>
			</tr>
		  </thead>
		  <tbody id='tb_LastCMDs'>
			
		  </tbody>
		</table>
    </div>
    <div class="card-footer text-center bg-dark">
		<div class="mx-auto">
			<button type="button" id="ClearLastCMDs" class="btn btn-outline-light btn-sm mb-2">Clear Commands Cache</button>
		</div>
    </div>
</div>

<!-- FXServer Control Card -->
        <div class="card card-accent-danger" style="min-height: 160px;">
            <div class="card-header font-weight-bold">FXServer Control:</div>
            <div class="card-body text-center align-middle">
                <button onclick="controlAction('start')" class="btn btn-outline-danger btn-lg mx-auto m-2"
                    type="button" id="ctrl-start" >START</button> &nbsp;
                <button onclick="controlAction('restart')" class="btn btn-outline-danger btn-lg mx-auto m-2"
                    type="button" id="ctrl-restart" >RESTART</button> &nbsp;
                <button onclick="controlAction('stop')" class="btn btn-outline-danger btn-lg mx-auto m-2"
                    type="button" id="ctrl-stop" >STOP</button>
            </div>
        </div>


{{@include("footer", it)/}}


<script src="js/ansi_up.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script>


	var lastCMDs = [];
	
	var exeCMD;

    //Socket
    (function () {
        let prefix = '';
        var socket = io({path: prefix + '/socket.io', transports: ['polling'], upgrade: false});
        var ansi_up = new AnsiUp;
        ansi_up.escape_for_html = false;

        var input = document.getElementById("cmdInput");
        var consoleElement = document.getElementById("console");
        var consoleForm = document.getElementById("frmConsole");

        //Events
        socket.on('connect', () => {
            console.log("Socket.io Connected!")
        });
        socket.on('logout', (error) => {
            window.location = '/auth?logout';
        });
        socket.on('consoleData', function (msg) {
            var _consoleData = consoleElement.innerHTML + ansi_up.ansi_to_html(msg);
            _consoleData = (_consoleData.length > bufferTrimSize)
                ? _consoleData.slice(-0.5 * bufferTrimSize) // grab the last half
                : _consoleData; // no need to trim
            consoleElement.innerHTML = _consoleData.substr(_consoleData.indexOf("\n"));
            if (autoScroll) consoleElement.scrollTop = consoleElement.scrollHeight
        });

        //Form
        consoleForm.addEventListener("submit", function (e) {
            e.preventDefault();
			
			let cmd = input.value;
			
			//store last command
			lastCMDs = lastCMDs.filter(item => item !== cmd);
			lastCMDs.unshift(cmd);
			updateLastCMDs();
			
			
            commandCache.unshift(input.value);
            socket.emit('consoleCommand', input.value);
            input.value = "";
        });

        //Up / Down history
        var commandCache = [];
        var currentIndex;
        input.addEventListener("keydown", function (event) {
            var changed = false;

            if (event.key === "ArrowUp") {
                changed = true;
                if (typeof currentIndex === 'undefined' && commandCache.length > 0) {
                    currentIndex = 0;
                } else if ((currentIndex + 1) < commandCache.length) {
                    currentIndex += 1;
                }

            } else if (event.key === "ArrowDown") {
                changed = true;
                if (currentIndex > 0) {
                    currentIndex -= 1;
                } else if (currentIndex === 0) {
                    currentIndex = undefined;
                }
            }

            if (changed) input.value = commandCache[currentIndex] || "";
        });

        //Buttons
        var autoScroll = true;
        var autoScrollToggle = document.getElementById("toggleAutoScroll");

        autoScrollToggle.addEventListener("click", function () {
            autoScroll = !autoScroll;
            autoScrollToggle.innerText = (autoScroll ? "Disable Scroll" : "Enable Scroll");
        });

        document.getElementById("clearConsole").addEventListener("click", function () {
            consoleElement.innerHTML = "";
        });
		
		
		exeCMD = function(btn){
	
			let cmd = $($(btn).parent().parent().find('.command')[0]).text();
			
			//store last command
			lastCMDs = lastCMDs.filter(item => item !== cmd);
			lastCMDs.unshift(cmd);
			updateLastCMDs();
			
			//execute
            socket.emit('consoleCommand', cmd);
	
		};
    })();
	
	function updateLastCMDs() {
		let content = '';
		lastCMDs.forEach((c,i) => {
			
			content += '<tr><th scope="row">' + i + '</th><td class="command">' + c + '</td><td><button type="button" class="btn btn-outline-light btn-sm mb-2 mr-1" onclick="exeCMD(this)">Execute</button><button data-toggle="tooltip" type="button" class="btn btn-outline-light btn-sm mb-2" onclick="CopyCMD(this)">Copy</button></td></tr>';
		
		});
		
		$('#tb_LastCMDs').html(content);
	}
	
	
    function CopyCMD(element) {
	
		let el = $(element);
	
		let text = $(el.parent().parent().find('.command')[0]).text();

        el.tooltip("hide");

        el.attr('data-original-title', 'Command Copied!');


        let dummy = document.createElement("input");
        document.body.appendChild(dummy);
        dummy.setAttribute('value', text);
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);

        el.tooltip('show');

        setTimeout(function(){ el.attr('data-original-title', 'Copy Command'); }, 1000);
    }
	
	
	$('#ClearLastCMDs').on('click', function() {
		$('#tb_LastCMDs').html('');
		lastCMDs = [];
	
	});
	
	//============================================== Controls (start/restart/stop)
    function controlAction(action) {
        if (action !== 'start' && !window.confirm('Are you sure you want to ' + action + ' the server?')) {
            return;
        }
        var notify = $.notify({ message: '<p class="text-center">Executing Command...</p>' }, {});
        $.ajax({
            url: actionURL = '/fxserver/controls/' + action,
            type: "GET",
            dataType: "json",
            timeout: timeoutLong,
            success: function (data) {
                if (data.logout) {
                    window.location = '/auth?logout';
                    return;
                }
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    }
</script>
